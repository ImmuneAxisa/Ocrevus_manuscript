---
title: "PBMC analysis"
author: "PPA"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    number_sections: yes
    toc: yes
    toc_depth: 4
  html_document:
    df_print: paged
geometry: margin=0.5in
header-includes:
   - \usepackage{subfig}
   - \usepackage{float}
---


```{r setup, include=FALSE}

##########################
## Packages and options ##
##########################

library(gridExtra)
library(knitr)
library(readr)
library(dplyr)
library(tidyr)
library(tibble)
library(stringr)
library(ggplot2)
library(ggExtra)
library(stats)
# library(RColorBrewer)
library(viridis)
library(scales)
library(ggrepel)
library(circlize)
library(RColorBrewer)
library(gplots)
library(cowplot)
library(gtable)
library(data.table)
library(Seurat)
library(hdf5r)
library(ggsci)
library(ggridges)
library(forcats)
library(kableExtra)
library(sp)
# library(FactoMineR)
# library(factoextra)
library(wesanderson)
library(magrittr)
library(ComplexHeatmap)
library(clustree)
library(colorspace)
library(tidygraph) 
library(readxl)
library(here)
library(ggh4x)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.pos = 'H')
knitr::opts_chunk$set(dev = 'png', dpi = 300)

#set root directory to be one level up of the current directory
#knitr::opts_knit$set(root.dir = '.')

#Caching option when tweaking the knitting
knitr::opts_chunk$set(cache = T)

WRITE_FILES <- FALSE


##################
## ggplot theme ##
##################

theme_mrl <- function(x = 1) {
  theme_minimal() +
    theme(
      axis.line = element_line(),
      axis.ticks.x = element_line(),
      axis.ticks.y = element_line(),
      axis.text.x = element_text(size = 12*x,face = "bold", angle = 45, vjust = 0.9, hjust=0.9),
      axis.text.y = element_text(size = 12*x,face = "bold"),
      axis.title.x = element_text(size = 12*x,face = "bold"),
      axis.title.y = element_text(size = 12*x,face = "bold"),
      strip.background = element_rect(fill="gray20", colour="gray20", linetype="solid"),
                                      strip.text = element_text(size=12*x, colour="white", face="bold"),
                                      legend.title = element_text(size=14*x, face = "bold"),
                                      legend.text = element_text(size=12*x, color="gray20", face="bold"),
      legend.background = element_rect(fill = "transparent", colour = "transparent"),
      plot.title =  element_text(hjust=0.5, vjust=2, face="bold"),
      plot.subtitle = element_text(hjust=0.5, vjust=3, face="italic"),
      plot.caption = element_text(hjust = 0, face = "italic")
                                      )
}


opts <- options()  # save old options

options(ggplot2.continuous.colour="viridis")
options(ggplot2.continuous.fill = "viridis")

palette <- c(pal_rickandmorty()(12),pal_jco()(10), pal_futurama()(11), pal_tron()(7))


options(bitmapType = 'cairo', device = 'png')
```



```{r, fig.width=10}  
# function to overlay values onto the UMAP embeddings
hex_plots <- function(data,dim1,dim2, color, facets = "", CI = 0.05) {

  # calculate the quantilles for CI limits onthe color scale.
  if(CI) {
    lims <- quantile(data[,color], probs = c(CI/2,1 - CI/2))
  } else {
    lims <- c(NA,NA)
  }
  
  
  ggplot(data, aes_string(dim1, dim2)) +
  stat_summary_hex(bins = 100,
                   fun = median,
                   aes(z= !!ensym(color), color = ..value..)) +
    facet_wrap(as.formula(paste(". ~", facets)), scales = "free") +
    ggtitle(color) +
    theme_mrl() +
    guides(fill = guide_none()) +
    scale_fill_viridis(limits = lims, oob = squish) +
    scale_color_viridis(limits = lims, oob = squish)
}

theme_umap <- function() {
  theme_void() +
    theme(panel.background = element_rect(fill = "grey90", color = "black", size = 2),
          legend.position = c(1,0),
          legend.justification = c(1.1,0),
          legend.direction = "horizontal",
          legend.text = element_text(angle = 45, hjust = 1, vjust = 1),
          legend.title = element_blank(),
          plot.margin = unit(c(1,1,1,1), "mm"),
          aspect.ratio = 0.7)
  
  
}

# function to overlay values onto the UMAP embeddings
hex_plots <-
  function(data,
           dim1,
           dim2,
           color,
           facets = NULL,
           CI = 0.05,
           fun = "mean",
           bins = 200,
           divergent_scale = F) {
    message("calc CI")
    # calculate the quantilles for CI limits onthe color scale.
    if (CI) {
      lims <- quantile(pull(data, color), probs = c(CI / 2, 1 - CI / 2))
      
      # if user supplied CI leads to 0 values ef no range, set automatically to 1%
      if (lims[2] == 0) {
        CI <- 0.01
        lims <-
          quantile(pull(data, color), probs = c(CI / 2, 1 - CI / 2))
      }
      # if still 0 values still, do not set any CI
      if (lims[2] == 0) {
        lims <- c(NA, NA)
      }
      
    } else {
      lims <- c(NA, NA)
    }
    
    message("compute plot")
    plot <- ggplot(data, aes_string(dim1, dim2)) +
      stat_summary_hex(
        bins = bins,
        fun = fun,
        aes(z = !!ensym(color), color = ..value..),
        lwd = 0.1
      ) +
      ggtitle(color) +
      theme_mrl() +
      guides(fill = guide_none()) +
      theme_umap()
    
    
    if (divergent_scale) {
      plot <- plot  +
        scale_fill_gradientn(
          colors = c("purple3","royalblue","grey80","red4","gold"),
          values = rescale(c(lims[1], quantile(pull(data, color), probs = c(0.25,0.5,0.75)), lims[2])),
          limits = lims,
          oob = squish,
          breaks = pretty_breaks(5)
        ) +
        scale_color_gradientn(
          colors = c("purple3","royalblue","grey80","red4","gold"),
          values = rescale(c(lims[1], quantile(pull(data, color), probs = c(0.25,0.5,0.75)), lims[2])),
          limits = lims,
          oob = squish,
          breaks = pretty_breaks(5)
        )
    } else {
      plot <- plot +
        scale_fill_viridis(limits = lims, oob = squish) +
        scale_color_viridis(limits = lims, oob = squish)
    }
    
    if (is.null(facets)) {
      return(plot)
    } else {
      return(plot + facet_wrap(as.formula(facets)))
    }
  }





ridges_plots <- function(data,dim1,dim2, facets) {
  
  ggplot(data, 
       aes_string(dim1, 
                  dim2)) +
  stat_density_ridges(aes(fill = factor(stat(quantile))),
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = c(0.01,0.05, 0.1,0.9,0.95,0.99), quantile_lines = TRUE,
    color = NA) +
  facet_grid(facets, scales = "free_y", space = "free_y") +
  scale_fill_manual(labels = c("0.01","0.05", "0.1","0.1-0.9","0.9","0.95","0.99"),
                    values = c("black","grey80","black","grey80","black","grey80","black"))
}





```




```{r import rds from Jess}

source("src/wrapper_scripts/results_annotations.R")


# store figs
pbmc_clust_figs <- list()

```


# Clustering summary


```{r, fig.width= 10, fig.asp=1}
best_clusters <- meta_table %>%
  dplyr::select(cell.id, curated_clusters, donor) %>%
  mutate(curated_clusters= as.numeric(curated_clusters)) %>%
  left_join(cluster_labels_table)


plot <- best_UMAP %>%
  left_join(best_clusters) %>%
  mutate(curated_clusters = as.factor(curated_clusters))




graph_tree <- plot %>%
  dplyr::select(coarse_clusters, cell_type, fine_clusters) %>%
  mutate(c_1 = unclass(as.factor(coarse_clusters)), 
         c_2 = unclass(as.factor(cell_type)), 
         c_3 = unclass(as.factor(fine_clusters))) 


annotation_tree <- graph_tree %>%
  distinct() %>%
  mutate(c_1__coarse_clusters = paste0(coarse_clusters,"__", c_1),
         c_2__cell_type = paste0(cell_type,"__", c_2),
         c_3__fine_clusters = paste0(fine_clusters,"__", c_3)) %>%
  dplyr::select(matches("^c_[0-9]__")) %>%
  pivot_longer(everything(), names_to = "cat", values_to = "clust") %>%
  separate(clust, c("clust_label", "clust_number"), sep = "__") %>%
  separate(cat, c("cat_number", "cat_label"), sep = "__") %>%
  mutate(node = paste0(cat_number, "C",clust_number)) %>%
  distinct()
  
         
annotated_graph <- graph_tree %>%
  clustree("c_", return = "graph") %>%
  activate("nodes") %>%
  left_join(annotation_tree) %>%
  activate("edges") %>%
  group_by(from) %>%
  mutate(prop = count / sum(count))

clust_tree <- ggraph(annotated_graph) +
  geom_edge_diagonal(aes(edge_width = prop), color = "grey60") +
  geom_node_point(aes(size = size, color = clust_label)) +
  geom_node_text(aes(y = ifelse(y == 0, y -0.1, y + 0.1), 
                     x = ifelse(y == 1, x - 0.4, x),
                     label = clust_label, 
                     hjust = ifelse(y == 0, 
                                    0,
                                    ifelse(y==1, 0.5,1)),
                     vjust = ifelse(y == 1, 0, 0.5)), 
                 repel = FALSE, 
                 force = 10) +
  coord_flip() +
  scale_x_reverse() +
  scale_y_reverse(breaks = 0:2, labels = c("communities", "fine-grained\ncell types", "coarse-grained\ncell types"),
                  expand = expand_scale(0.5)) +
  theme(aspect.ratio = 1.5,
        axis.text.x = element_text(hjust = 0.5),
        legend.position = c(0,1),
        legend.justification = c(0,1),
        panel.border = element_rect(color = "black", fill = NA, linetype = "solid", linewidth = 1),
        legend.background = element_blank()) +
  guides(color = guide_none()) +
  scale_edge_width(range = c(0.5,3)) +
  scale_size(range = c(3,10)) +
  scale_color_manual(values = palette_master)

clust_tree

pbmc_clust_figs[["cluster_tree"]] <- clust_tree
```

## Coarse calls


```{r, fig.width= 15}

cluster_labels <- plot %>%
  group_by(coarse_clusters) %>%
  summarize(dim_1 = median(dim_1), dim_2 = median(dim_2))


umap_plot <- plot %>%
  ggplot(aes(dim_1,
             dim_2)) +
  geom_hex(aes(fill = coarse_clusters, alpha = log(..ndensity..)),
           bins = 300,
           lwd = 0.001) +
  geom_label_repel(
    data = cluster_labels,
    aes(label = coarse_clusters, fill = as.character(coarse_clusters)),
    color = "black",
    size = 5,
    alpha = 0.8,
    min.segment.length = unit(0, "cm")
  ) +
  scale_alpha(range = c(0.2, 1)) +
  theme_cowplot() +
  #theme_mrl() +
  #facet_wrap(min.dist ~ spread, scales = "free", ncol = 2) +
  theme(
    panel.background = element_rect(fill = 'grey80', color = "black"),
    legend.position = "none",
    axis.line = element_blank()
  ) +
  scale_fill_manual(values = palette_master) +
  scale_color_manual(values = palette_master) +
  #ggtitle(knn) +
  labs(x = "UMAP1", y = "UMAP2")

umap_plot
pbmc_clust_figs[["umap_coarse"]] <- umap_plot
```

## Fine grained clusters

```{r higher res clusters, fig.width=10, fig.asp= 1}


cluster_labels <- plot %>%
  group_by(curated_clusters) %>%
  summarize(dim_1 = median(dim_1), dim_2 = median(dim_2))

umap_plot <- plot %>%
  ggplot(aes(dim_1,
             dim_2)) +
  geom_hex(aes(fill = curated_clusters, alpha = log(..ndensity..)),
           bins = 300,
           lwd = 0.001) +
  geom_label_repel(data = cluster_labels, 
             aes(label = curated_clusters, fill = as.character(curated_clusters)), 
             color = "black", size =5, alpha = 0.8) +
  scale_alpha(range = c(0.2, 1)) +
  theme_mrl() +
  facet_wrap(min.dist ~ spread, scales = "free", ncol = 2) +
  theme(panel.background = element_rect(fill = 'grey90', color = NA),
        legend.position = "bottom") +
  scale_fill_manual(values = palette) +
  scale_color_manual(values = palette)

umap_plot
```



```{r, fig.width= 15}


kable(arrange(cluster_labels_table, coarse_clusters, curated_clusters))
```


```{r,fig.width = 20 ,eval=F}

plot_grid(grid.table(arrange(cluster_labels_table, coarse_clusters, curated_clusters)))

```





## Fine calls

### Main UMAP


```{r, fig.width= 10}
cluster_labels <- plot %>%
  group_by(fine_clusters, curated_clusters) %>%
  summarize(dim_1 = median(dim_1), dim_2 = median(dim_2))


umap_plot <- plot %>%
  ggplot(aes(dim_1,
             dim_2,
             fill = reorder(
               fine_clusters, as.numeric(curated_clusters)
             ))) +
  geom_hex(aes(alpha = log(..ndensity..)),
           bins = 300,
           lwd = 0.001) +
  geom_label_repel(
    data = cluster_labels,
    aes(label = paste(curated_clusters, fine_clusters)),
    color = "black",
    size = 5,
    alpha = 0.8,
    min.segment.length = unit(0, "cm"),
    force = 50,
    max.iter = 10000
  ) +
  scale_alpha(range = c(0.2, 1)) +
  theme_cowplot() +
  #theme_mrl() +
  #facet_wrap(min.dist ~ spread, scales = "free", ncol = 2) +
  theme(
    panel.background = element_rect(fill = 'grey80', color = "black"),
    legend.position = "none",
    axis.line = element_blank()
  ) +
  scale_fill_manual(values = palette_master) +
  scale_color_manual(values = palette_master) +
  #ggtitle(knn) +
  labs(x = "UMAP1", y = "UMAP2") +
  guides(label = "none",
         alpha = "none",
         fill = guide_legend(title = "cluster", override.aes = aes(label = ""))) +
  scale_x_continuous(expand = expansion(c(0.3,0.3))) +
  scale_y_continuous(expand = expansion(c(0.3,0.3)))


umap_plot
pbmc_clust_figs[["umap_com"]] <- umap_plot
```

### cell type UMAP


```{r, fig.width= 10}
cluster_labels <- plot %>%
  mutate(cell_type = fct_infreq(cell_type)) %>%
  group_by(cell_type) %>%
  summarize(dim_1 = median(dim_1), dim_2 = median(dim_2))


umap_plot <- plot %>%
  ggplot(aes(dim_1,
             dim_2,
             fill = cell_type)) +
  geom_hex(aes(alpha = log(..ndensity..)),
           bins = 300,
           lwd = 0.001) +
  geom_text_repel(
    data = cluster_labels,
    aes(label = gsub("_"," ",cell_type)),
    color = "black",
    size = 5,
    alpha = 0.8,
    min.segment.length = unit(0, "cm"),
    force = 1,
    max.iter = 10000#,
    #nudge_x = (cluster_labels$dim_1)^-1,
    #nudge_y = cluster_labels$dim_2 * 0.7
  ) +
  scale_alpha(range = c(0.2, 1)) +
  theme_cowplot() +
  #theme_mrl() +
  #facet_wrap(min.dist ~ spread, scales = "free", ncol = 2) +
  theme(
    panel.background = element_rect(fill = 'grey80', color = "black"),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    axis.line = element_blank()
  ) +
  scale_fill_manual(values = palette_master) +
  scale_color_manual(values = palette_master) +
  #ggtitle(knn) +
  labs(x = "UMAP1", y = "UMAP2") +
  guides(label = "none",
         alpha = "none",
         fill = guide_legend(title = "cluster", override.aes = aes(label = ""))) +
  annotate("text", label = "UMAP", x = -Inf, y = -Inf, hjust = -0.5, vjust = -0.5)

umap_plot
pbmc_clust_figs[["umap_ct"]] <- umap_plot

```



```{r, fig.width= 10}
cluster_labels <- plot %>%
  mutate(cell_type = fct_infreq(cell_type)) %>%
  dplyr::filter(coarse_clusters == "myeloid") %>%
  group_by(cell_type) %>%
  summarize(dim_1 = median(dim_1), dim_2 = median(dim_2))


plot %>%
  #dplyr::filter(coarse_clusters == "myeloid") %>%
  ggplot(aes(dim_1,
             dim_2,
             fill = cell_type)) +
  geom_hex(aes(alpha = log(..ndensity..)),
           bins = 300,
           lwd = 0.001) +
  geom_label_repel(
    data = cluster_labels,
    aes(label = cell_type),
    color = "black",
    size = 5,
    alpha = 0.8,
    min.segment.length = unit(0, "cm"),
    #force = 50,
    max.iter = 10000,
  ) +
  scale_alpha(range = c(0.2, 1)) +
  theme_cowplot() +
  #theme_mrl() +
  #facet_wrap(min.dist ~ spread, scales = "free", ncol = 2) +
  theme(
    panel.background = element_rect(fill = 'grey80', color = "black"),
    legend.position = "none",
    axis.line = element_blank()
  ) +
  scale_fill_manual(values = palette) +
  scale_color_manual(values = palette) +
  #ggtitle(knn) +
  labs(x = "UMAP1", y = "UMAP2") +
  guides(label = "none",
         alpha = "none",
         fill = guide_legend(title = "cluster", override.aes = aes(label = ""))) +
  scale_x_continuous(expand = expansion(c(0,0))) +
  scale_y_continuous(expand = expansion(c(0,0))) +
  coord_cartesian(xlim=c(-32,-16),
                  ylim=c(-27,25))



```


### per lineage (=coarse) UMAP

```{r, fig.width=15}




curated_types_analysis <- meta_table %>%
  mutate(coarse_clusters = as.factor(coarse_clusters)) %>%
  left_join(cluster_labels_table %>% mutate(curated_clusters = as.numeric(curated_clusters)))

#colnames(curated_types_analysis)

cluster_labels <- curated_types_analysis %>%
  group_by(curated_clusters, coarse_clusters) %>%
  summarize(coarse_UMAPn50xMd05xS5_1 = median(coarse_UMAPn50xMd05xS5_1), coarse_UMAPn50xMd05xS5_2 = median(coarse_UMAPn50xMd05xS5_2))


curated_types_analysis %>%
  mutate(order = runif(nrow(curated_types_analysis))) %>%
  arrange(-order) %>%
  ggplot(aes(coarse_UMAPn50xMd05xS5_1, coarse_UMAPn50xMd05xS5_2)) +
  geom_point(aes(color = paste(curated_clusters,meta_subC)),
             alpha = 0.5) +
  geom_label_repel(data = cluster_labels, 
             aes(label = curated_clusters, fill = as.character(curated_clusters)), 
             color = "black", size =5, alpha = 0.8) +
  facet_wrap(.~coarse_clusters, scales = "free") +
  scale_color_manual(values = palette) +
  scale_fill_manual(values = palette) +
  theme_mrl() +
  theme(legend.position = "none") 




```


# Abundance variation analysis

## MELD analysis


```{r, fig.width= 10}
MELD_LLH <- read.csv("results/PBMC/phate_meld_output/input_iterative_harmony_curated_clusters_MELD_LLH.csv")

MELD_LLH <- plot %>%
  left_join(MELD_LLH, by =c("cell.id" = "index"))


umap_plot <- hex_plots(MELD_LLH, "dim_1", "dim_2", "t6M", CI = 0.05, divergent_scale = T) +
  theme_cowplot() +
  theme(
    panel.background = element_rect(fill = 'grey80', color = "black"),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = c(1,1),
    legend.justification = c(1,1),
    legend.direction = "horizontal",
    legend.title.align = 0.5,
    axis.line = element_blank(),
    strip.text = element_blank(),
    strip.background = element_blank(),
    legend.key.height = unit(10, "mm")
    
  ) +
  ggtitle(NULL) +
  guides(color = guide_colorbar(title = "follow up vs baseline\nMELD likelihood ",
                                title.position = "top",
                                #title.hjust = 1,
                                barwidth = 7,
                                barheight = 0.5,
                                label.theme = element_text(angle = 45, hjust = 0.7, vjust = 1)))  +
  annotate("text", label = "UMAP", x = -Inf, y = -Inf, hjust = -0.5, vjust = -0.5)


umap_plot
pbmc_clust_figs[["umap_meld"]] <- umap_plot
```


```{r, fig.width=20, fig.asp=0.7}
meld_violins <- MELD_LLH %>%
  dplyr::filter(coarse_clusters != "other") %>%
  group_by(coarse_clusters, fine_clusters, donor) %>%
  summarize(mean_MELD = mean(t6M), se_MELD = sd(t6M)) %>%
  ungroup() %>%
  ggplot() +
  geom_rect(xmin = -Inf, xmax = Inf, ymin = 0.4, ymax = 0.6, fill = "grey") +
  geom_hline(yintercept = c(0.5,1)) +
  geom_violin(data = MELD_LLH %>% dplyr::select(t6M), aes(relevel(as.factor("_global"), ref ="_global"), t6M)) +
  #annotate("text", x = "", y = 0.5, label = "global", angle = 90) +
  geom_pointrange(aes(reorder(as.factor(fine_clusters), mean_MELD), 
                      mean_MELD,
                      ymin = mean_MELD -se_MELD,
                      ymax = mean_MELD + se_MELD,
                      group = donor, 
                 fill = as.factor(fine_clusters)),
               position = position_dodge(width = 0.8),
               shape = 21,
               size = 0.3,
               alpha = 1) +
  scale_fill_manual(values = palette) +
  theme_mrl(2) +
  labs(x = NULL, y = "Follow up vs baseline MELD likelihood") +
  scale_y_continuous(breaks = 0:10/10,
                     limits = c(0,1),
                     expand = expand_scale(mult = 0)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size = 1),
        axis.line = element_blank(),
        legend.position = "none",
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "plain", color = "black", size = 14),
    axis.text.x = element_text(color = "black", face = "plain", size = 14),
    axis.text.y = element_text(color = "black", face = "plain", size = 14),
    axis.title.y = element_text(color = "black", face = "plain", size = 14),
        aspect.ratio = 0.5) +
  guides(fill = guide_legend(ncol = 1)) +
  facet_wrap(.~ coarse_clusters, scales = "free_x") +
  scale_x_discrete(labels = function(x) gsub("_", " ", x))

meld_violins
pbmc_clust_figs[["meld_violins"]] <- meld_violins
```


```{r, fig.width=20, fig.asp=0.7}
# old not looking nice plots
if(F) {
  meta_table %>%
    dplyr::select(cell.id, donor) %>%
    distinct() %>%
    right_join(MELD_LLH) %>%
    dplyr::select(curated_clusters, t6M, donor, coarse_clusters) %>%
    group_by(curated_clusters, donor, coarse_clusters) %>%
    summarize(
      median = median(t6M),
      q25 = quantile(t6M, 0.25),
      q75 = quantile(t6M, 0.75),
      count = n()
    ) %>%
    ggplot(aes(as.factor(curated_clusters),
               group = donor)) +
    geom_rect(
      xmin = -Inf,
      xmax = Inf,
      ymin = 0.4,
      ymax = 0.6,
      fill = "grey"
    ) +
    geom_hline(yintercept = c(0, 0.5, 1)) +
    geom_crossbar(aes(
      ymin = q25,
      y = median,
      ymax = q75,
      fill = log10(count)
    ),
    position = position_dodge2(preserve = "single")) +
    #geom_point(aes(y = mean, size = log10(count), color = log10(count)), position = position_dodge2(preserve = "single")) +
    labs(x = "clusters", y = "MELD P of Ocrevus treatment") +
    theme_mrl() +
    scale_y_continuous(
      breaks = 0:10 / 10,
      limits = c(0, 1),
      expand = expand_scale(mult = 0.00)
    ) +
    theme(
      panel.border = element_rect(
        colour = "black",
        fill = NA,
        size = 1
      ),
      axis.line = element_blank(),
      legend.position = "right"
    ) +
    guides(fill = guide_colorbar(ncol = 1)) +
    facet_wrap(. ~ coarse_clusters, scales = "free_x")
  
  
  
  
  plot1 <- ggplot(MELD_LLH, aes(as.factor(curated_clusters),
                                t6M,
                                fill = donor)) +
    geom_rect(
      xmin = -Inf,
      xmax = Inf,
      ymin = 0.4,
      ymax = 0.6,
      fill = "grey"
    ) +
    geom_hline(yintercept = c(0.5, 1)) +
    geom_boxplot(
      aes(),
      outlier.size = 0.4,
      alpha = 0.6,
      position = position_dodge2(preserve = "single")
    ) +
    stat_summary(
      aes(color = ..cell_count..),
      fun.data = function(y, upper_limit = NA)
        data.frame(y = 1.05, cell_count = length(y)) ,
      geom = "point",
      size = 1,
      shape = 15,
      position = position_dodge2(width = 0.75, preserve = "single"),
      angle = 90
    ) +
    theme_mrl() +
    scale_color_viridis(direction = -1,
                        trans = "log10") +
    labs(x = "clusters", y = "MELD P of Ocrevus treatment") +
    scale_y_continuous(
      breaks = 0:10 / 10,
      limits = c(0, 1.1),
      expand = expand_scale(mult = 0.002)
    ) +
    theme(
      panel.border = element_rect(
        colour = "black",
        fill = NA,
        size = 1
      ),
      axis.line = element_blank(),
      legend.position = "right",
      strip.text = element_blank()
    ) +
    guides(fill = guide_legend(ncol = 1)) +
    facet_wrap(. ~ as.numeric(curated_clusters) > 20,
               scales = "free_x",
               ncol = 1)
  
  #ggsave("./figs/MELD_plot.png",plot, width = 15, height = 10)
  
  
  plot1
}
```


## Frequency variation


### overall

```{r, fig.width=15, fig.asp=2}
freq <- meta_table %>%
  #dplyr::filter(coarse_clusters == "myeloid") %>%
  mutate(curated_clusters = paste0("c", curated_clusters)) %>%
  group_by(curated_clusters, donor, treatment) %>%
  summarize(count = n()) %>%
  pivot_wider(names_from = curated_clusters, values_from = count, values_fill = 0) %>%
  pivot_longer(-c(donor, treatment), values_to = "count", names_to = "curated_clusters") %>%
  group_by(donor, treatment) %>%
  mutate(freq = count / sum(count) * 100,
         curated_clusters = parse_number(curated_clusters)) %>%
  left_join(cluster_labels_table)


freq %>%
  group_by(coarse_clusters) %>%
  nest() %>%
  mutate(
    plots = purrr::map2(
      data,
      coarse_clusters,
      ~.x %>%
        ggplot(aes(treatment, freq, fill = treatment)) +
        geom_boxplot() +
        geom_line(aes(group = donor)) +
        facet_wrap(
          as.numeric(curated_clusters) ~ fine_clusters,
          scales = "free_y",
          ncol = 8
        ) +
        ggsignif::geom_signif(comparisons = list(c("t0M", "t6M"))) +
        scale_y_continuous(expand = expansion(0.1)) +
        ggtitle(.y) +
        theme_mrl() +
        theme(axis.text.x = element_blank(),
              axis.title.x = element_blank())
      
    )
  ) %>%
  pull(plots) %>%
  plot_grid(plotlist = ., ncol = 1)
```

```{r, fig.width=10, fig.asp=0.5}
betareg_model <- freq %>%
  mutate(freq = freq/100 + 0.001) %>%
  group_by(curated_clusters, fine_clusters, coarse_clusters) %>%
  nest() %>%
  mutate(lm_model = purrr::map(data, ~betareg::betareg(freq ~ treatment + donor, .x, link = "logit"))) %>%
  mutate(lm_result = purrr::map(lm_model, broom::tidy)) %>%
  dplyr::select(-data)

avg_freqs <- freq %>%
  mutate(freq = freq/100 + 0.001) %>%
  group_by(curated_clusters, fine_clusters, coarse_clusters) %>% 
  summarize(freq = mean(freq))

diagnostic_metrics <- betareg_model %>%
  mutate(deviance_residuals = purrr::map(lm_model, residuals, type = "deviance"),
         cooks_distance = purrr::map(lm_model, cooks.distance)) %>%
  mutate(residuals = purrr::map(lm_model, residuals, type = "response"),
         #pearson_residuals = purrr::map(lm_model, residuals, type = "pearson"),
         fitted = purrr::map(lm_model, fitted, type = "response")) %>% 
  dplyr::select(residuals, fitted, deviance_residuals, cooks_distance) %>%
  left_join(avg_freqs) %>%
  unnest() %>%
  mutate(observed = fitted+residuals) 


p1 <- diagnostic_metrics %>%
  ggplot(aes(observed, fitted)) +
  geom_hex(bins = 50) +
  scale_x_log10() +
  scale_y_log10() +
  geom_smooth(method = "lm") +
  scale_fill_continuous(trans = "log10", limits = c(1,10), oob = oob_squish) +
  theme_bw()

p2 <- diagnostic_metrics %>%
  ggplot(aes(observed, deviance_residuals)) +
  geom_hex(bins = 50) +
  scale_x_log10() +
  scale_fill_continuous(trans = "log10", limits = c(1,10), oob = oob_squish) +
  theme_bw() 


p3 <- diagnostic_metrics %>%
  ggplot(aes(observed, cooks_distance)) +
  geom_hex(bins = 50) +
  scale_x_log10() +
  #scale_y_log10() +
  geom_smooth(method = "lm") +
  scale_fill_continuous(trans = "log10") +
  theme_bw()

p1 + p2 + patchwork::plot_layout(ncol = 2, guides = "collect", axes = "collect")

```


```{r, fig.width=5, fig.asp=1.2}
betareg_results <- betareg_model %>%
  dplyr::select(-lm_model) %>%
  unnest() %>%
  dplyr::filter(grepl("treatment", term)) %>%
  ungroup() %>%
  mutate(fdr = purrr::map(p.value, ~p.adjust(.x, method = "fdr"))) %>%
  unnest() 

freq_volcano <- betareg_results %>%
  mutate(fine_clusters = ifelse(coarse_clusters %in% c("myeloid", "Bcells") & p.value < 10^-10, fine_clusters, "")) %>%
  mutate(sign = ifelse(fdr < 0.1 & estimate > 0, "up",
                       ifelse(fdr < 0.1 & estimate < 0, "dn", "ns"))) %>%
  mutate(break_point = -log10(p.value) < 40) %>%
  ggplot(aes(estimate, -log10(p.value))) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(data = data.frame(break_point = c(TRUE, FALSE), intercept = c(NA, 40)), aes(yintercept = intercept), linetype = "dashed") +
  geom_errorbarh(aes(xmin = estimate - std.error, xmax = estimate + std.error)) +
  geom_text_repel(aes(label = gsub("_"," ",fine_clusters)),
                   min.segment.length = unit(0,"mm"),
                   force = 100,
                  size = 6) +
  geom_point(aes(fill = sign), shape = 21, size =3) +
  theme_mrl() +
  facet_grid(break_point ~., scale = "free_y") +
  labs(x = "log fold change") +
  theme(strip.text = element_blank(), strip.background = element_blank(),
        #panel.border= element_rect(fill = NA, color = "black", linetype = "solid"),
        #axis.line = element_blank(),
        panel.spacing = unit(0, "in"),
        legend.position = "none",
        axis.text.x = element_text(color = "black", face = "plain", size = 14),
    axis.text.y = element_text(color = "black", face = "plain", size = 14),
    axis.title.x = element_text(color = "black", face = "plain", size = 14),
    axis.title.y = element_text(color = "black", face = "plain", size = 14)) +
  scale_fill_manual(values = c(dn = "lightblue", ns = "black", up = "lightcoral")) +
  scale_y_continuous(expand = expansion(0.02), breaks = pretty_breaks(8), sec.axis = sec_axis(~., breaks = NULL)) +
  scale_x_continuous(sec.axis = sec_axis(~., breaks = NULL))
  
freq_volcano
pbmc_clust_figs[["freq_volcano"]] <- freq_volcano

```


### Myeloid only

```{r, fig.width=15, fig.asp=1}
freq <- curated_types_analysis %>%
  dplyr::filter(coarse_clusters == "myeloid") %>%
  mutate(curated_clusters = paste0("c", curated_clusters)) %>%
  group_by(curated_clusters, donor, treatment) %>%
  summarize(count = n()) %>%
  pivot_wider(names_from = curated_clusters, values_from = count, values_fill = 0) %>%
  pivot_longer(-c(donor, treatment), values_to = "count", names_to = "curated_clusters") %>%
  group_by(donor, treatment) %>%
  mutate(freq = count / sum(count) * 100,
         curated_clusters = as.character(parse_number(curated_clusters))) %>%
  left_join(cluster_labels_table %>% mutate(curated_clusters = as.character(curated_clusters)))


freq_violins <- freq %>%
  group_by(coarse_clusters) %>%
  nest() %>%
  mutate(
    plots = purrr::map2(
      data,
      coarse_clusters,
      ~.x %>%
        ggplot(aes(treatment, freq, fill = treatment)) +
        geom_boxplot() +
        geom_line(aes(group = donor)) +
        facet_wrap(
          .~ fine_clusters,
          scales = "free_y",
          ncol = 3
        ) +
        #ggsignif::geom_signif(comparisons = list(c("t0M", "t6M"))) +
        scale_y_continuous(expand = expansion(0.1)) +
        ggtitle(.y) +
        theme_mrl() +
        theme(axis.text.x = element_blank(),
              axis.title.x = element_blank())
      
    )
  ) %>%
  pull(plots) %>%
  plot_grid(plotlist = ., ncol = 1)



freq_violins
pbmc_clust_figs[["freq_violins"]] <- freq_violins
```


### Alternate modelling on counts using `sccomp` package

```{r, fig.width=7, fig.asp=0.5}






library(sccomp)



sccomp_paired <- readRDS("reviewing/sccomp_paired.rds")

plots <- sccomp_paired %>%
  dplyr::filter(!grepl("donor", parameter)) %>%
  plot_summary(0.1)

plots$credible_intervals_1D +
  ggtitle("sccomp coefficients") +
  scale_color_manual(labels = c("n.s.", "FDR < 0.025"), values = c("darkred", "royalblue")) +
  theme(legend.position = c(0,1),
        legend.background = element_blank(),
        legend.justification = c(0,1),
        axis.title.y = element_blank(),
        legend.title = element_blank()) +
  scale_x_continuous(n.breaks = 6)


library(writexl)

supplementary_data_3 <- list(betareg_model = betareg_results, sccomp_model = sccomp_paired %>% dplyr::select(-count_data) %>% dplyr::filter(grepl("treatment", parameter)))


write_xlsx(supplementary_data_3, "reviewing/SD3_pbmc_freqs.xlsx")

```




```{r, fig.width=4}
sccomp_paired %>%
  dplyr::select(-count_data) %>%
  dplyr::filter(grepl("treatment", parameter)) %>%
  mutate(fine_clusters = ifelse(grepl("DC|Mono|^B ", fine_clusters), fine_clusters, NA)) %>%
  ggplot(aes(c_effect, -log10(c_FDR))) +
  geom_point() +
  geom_label_repel(aes(label = fine_clusters), force = 100, min.segment.length = 0) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  scale_y_continuous(expand = expansion(c(0.05,0.25)), oob = oob_squish_infinite) +
  theme_bw()


sccomp_paired %>%
  dplyr::select(fine_clusters, parameter, c_effect, c_FDR) %>%
  dplyr::filter(grepl("treatment", parameter)) %>%
  left_join(betareg_results %>% dplyr::select(fine_clusters, beta_effect = estimate, p.value)) %>%
  ggplot(aes(beta_effect, c_effect)) +
  geom_abline() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  labs(x = "beta regression coefficient", y = "sccomp coefficient")
  
```



# Comparison of singleR score distributions across clusters / samples.

## all cell types scoring


```{r, fig.width=10}
mon_sc <- readRDS("results/PBMC/clustering/cell_typing_sc_curated_types_master_seurat_harmony_iterative_batch_emulsion.rds")[[1]]


rownames(mon_sc[[1]]) <- rownames(mon_sc[[2]])


mon_sc <- mon_sc[[1]]

#mon_sc <- mon_sc[, grepl("monocytes", colnames(mon_sc))]

mon_sc <- mon_sc[pull(curated_types_analysis, cell.id),]

#mon_sc <- mon_sc / matrixStats::rowMaxs(mon_sc)

covs <- curated_types_analysis %>%
  mutate(nCount_RNA = log10(nCount_RNA)) %>%
  dplyr::select(nCount_RNA)

mon_sc_corrected <- apply(mon_sc, 2, function(ref_scores){
  
  data <- covs %>%
    mutate(score = ref_scores) 
  
  residuals <-data %>%
    lm(score~nCount_RNA, data = .) %>%
    residuals()
  
  print(ggplot(data, aes(nCount_RNA, score)) +
    geom_hex(bins = 100) +
    ggtitle("before"))
  
  print(qplot(pull(data, nCount_RNA), residuals, geom = "hex", bins = 100)  +
    ggtitle("after"))
  
  return(residuals)
  
})


#identical(rownames(mon_sc_corrected),pull(curated_types_analysis, cell.id))


rownames(mon_sc_corrected) <-rownames(mon_sc)

cluster_scores <- aggregate(mon_sc_corrected, list(curated_clusters = pull(curated_types_analysis,curated_clusters)), "mean") %>%
  left_join(cluster_labels_table %>% dplyr::select(curated_clusters, fine_clusters)) %>%
  tibble::column_to_rownames("fine_clusters") %>%
  dplyr::select(-curated_clusters) %>%
  as.matrix() %>%
  apply(2, rescale)



hm_scores <- Heatmap(t(cluster_scores),
        colorRamp2(0:10 / 10, viridisLite::viridis(11, option = "A")),
        "singleR score", 
        column_split = cluster_labels_table$coarse_clusters)

hm_grob <- grid.grabExpr(draw(hm_scores))

pbmc_clust_figs[["hm_grob"]] <- hm_grob

grid.arrange(hm_grob)

```


## monocytes fine tuning


```{r,fig.width=10}
mon_sc <- readRDS("results/PBMC/clustering/cell_typing_sc_curated_types_master_seurat_harmony_iterative_batch_emulsion.rds")[[1]]


rownames(mon_sc[[1]]) <- rownames(mon_sc[[2]])


mon_sc <- mon_sc[[1]]

mon_sc <- mon_sc[, grepl("monocytes", colnames(mon_sc))]

mon_sc <- mon_sc[pull(curated_types_analysis, cell.id),]

#mon_sc <- mon_sc / matrixStats::rowMaxs(mon_sc)

covs <- curated_types_analysis %>%
  mutate(nCount_RNA = log10(nCount_RNA)) %>%
  dplyr::select(nCount_RNA)

mon_sc_corrected <- apply(mon_sc, 2, function(ref_scores){
  
  data <- covs %>%
    mutate(score = ref_scores) 
  
  residuals <-data %>%
    lm(score~nCount_RNA, data = .) %>%
    residuals()
  
  p1 <- ggplot(data, aes(nCount_RNA, score)) +
    geom_hex(bins = 100) +
    ggtitle("before")
  
  p2 <- qplot(pull(data, nCount_RNA), residuals, geom = "hex", bins = 100)  +
    ggtitle("after")
  
  print(plot_grid(p1,p2))

  return(residuals)
  
})

rownames(mon_sc_corrected) <-rownames(mon_sc)

scores_comparison <- as.data.frame(mon_sc_corrected) %>%
  tibble::rownames_to_column("cell.id") %>%
  right_join(curated_types_analysis) %>%
  dplyr::filter(grepl("Mono", fine_clusters)) %>%
  dplyr::left_join(cluster_labels_table %>% mutate(curated_clusters = as.integer(curated_clusters)))



ggplot(scores_comparison, aes(treatment, `Classical monocytes`, group = paste(donor,treatment))) +
  stat_boxplot() +
  facet_wrap(.~paste(curated_clusters, fine_clusters)) +
  theme_mrl()

ggplot(scores_comparison, aes(treatment, `Intermediate monocytes`, group = paste(donor,treatment))) +
  stat_boxplot() +
  facet_wrap(.~paste(curated_clusters, fine_clusters)) +
  theme_mrl()


ggplot(scores_comparison, aes(treatment, `Non classical monocytes`, group = paste(donor,treatment))) +
  stat_boxplot() +
  facet_wrap(.~paste(curated_clusters, fine_clusters)) +
  theme_mrl()
```


```{r,fig.width=10}
scores_comparison <-  apply(mon_sc_corrected, 2, rescale) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("cell.id") %>%
  right_join(curated_types_analysis) %>%
  dplyr::filter(grepl("Mono", fine_clusters)) %>%
  dplyr::left_join(cluster_labels_table %>% mutate(curated_clusters = as.integer(curated_clusters)))

ggplot(scores_comparison, aes(
  `Classical monocytes`,
  (`Intermediate monocytes` - `Non classical monocytes`)
)) +
  facet_wrap(. ~ paste(curated_clusters, fine_clusters)) +
  geom_bin_2d(aes(color = after_scale(fill), fill = after_stat(ncount))) +
  scale_fill_viridis(trans = "log10") +
  geom_hline(yintercept = 0, color = "red")
```


```{r,fig.width=10}
scores_comparison <-
  as.data.frame(mon_sc / matrixStats::rowMaxs(mon_sc)) %>%
  tibble::rownames_to_column("cell.id") %>%
  right_join(curated_types_analysis) %>%
  dplyr::filter(grepl("Mono", fine_clusters)) %>%
  dplyr::left_join(cluster_labels_table %>% mutate(curated_clusters = as.integer(curated_clusters)))



mono_scores_plot <- ggplot(scores_comparison, aes(
  log(`Intermediate monocytes` / `Classical monocytes`),
  log(`Non classical monocytes` / `Intermediate monocytes`)
)) +
  facet_wrap(. ~ fine_clusters) +
  geom_hex(aes(color = after_scale(fill), fill = after_stat(ncount))) +
  scale_fill_viridis(trans = "log10") +
  geom_hline(yintercept = 0, color = "red") +
  geom_vline(xintercept = 0, color = "red") +
  #geom_abline(color = "red") +
  #scale_x_log10() +
  theme_mrl() +
  geom_text(data = tibble(
    x = c(-Inf, Inf, Inf),
    hjust = c(0, 1,1),
    y = c(-Inf,-Inf, Inf),
    vjust = c(0,0,1),
    label = c("classical", "intermediate", "non-classical")
  ),
  aes(x,y, label = label, hjust = hjust, vjust = vjust))

mono_scores_plot
pbmc_clust_figs[["mono_scores_plot"]] <- mono_scores_plot



```






```{r, fig.width=4, fig.asp=2}

myeloid_seurat <- readRDS("results/PBMC/seurat_objects/master_seurat_post_harmony_iterative_batch_emulsion.rds")

myeloid_meta <- curated_types_analysis %>%
  dplyr::filter(coarse_clusters == "myeloid")

myeloid_seurat <- myeloid_seurat[,pull(myeloid_meta,cell.id)]
gc()
myeloid_seurat@meta.data <- tibble::column_to_rownames(myeloid_meta,"cell.id")

myeloid_markers <- myeloid_seurat@assays$RNA@data[c("CCR2", "CD36", "CD14", "FCGR1A", "CD33", "ITGAX", "FCGR3A", "SECISBP2L", 
                          "CXCR4", "CCR5", "CD74", "CX3CR1", "HLA-DRA", "HLA-DRB5", "HLA-DRB1",
                          "TOB1", "FCGR3B", "CDKN1C","NFKBIZ", "TCF7L2", "FCGR2A", "MS4A6A",
                          "CSTA", "CSF3R", "ANPEP", "IER2",
                          "ATG2A", "ATP5PO", "DDX39A", "EVL", "GPR183", "LPCAT1", "POU2F2", "TSC22D4", "ZNF14", "ARHGAP27"),] %>%
  Matrix::t() %>%
  aggregate(list(fine_clusters = myeloid_meta$fine_clusters), "mean") %>%
  tibble::column_to_rownames("fine_clusters") %>%
  apply(2, rescale) %>%
  t() %>%
  Heatmap(colorRamp2(0:10 / 10, viridis(11, option = "A")), "gene\nexpression")



myeloid_markers <- grid.grabExpr(draw(myeloid_markers))

pbmc_clust_figs[["hm_grob_myeloid"]] <- myeloid_markers

grid.arrange(myeloid_markers)



#CD14 and CD16 plots
myeloid_main_markers <- VlnPlot(myeloid_seurat, c("CD14", "FCGR3A"), group.by = "fine_clusters", pt.size = 0, adjust = 2, combine = F) %>%
  lapply(function(p) p + theme_mrl() + theme(axis.title.x = element_blank(),
                                             axis.title.y = element_blank(),
                                             legend.position = "none",
                                             aspect.ratio = 1)) %>%
  plot_grid(plotlist = .)


pbmc_clust_figs[["myeloid_main_markers"]] <- myeloid_main_markers
myeloid_main_markers


```



```{r, fig.width=25, fig.asp= 2}
saveRDS(pbmc_clust_figs, "figs/pbmc_clust_figs.rds")

```

# Manuscript figure initial construction

```{r}
library(patchwork)
pbmc_clust_figs <- readRDS("figs/pbmc_clust_figs.rds")

tag_theme <- function(x) {
  
    theme(plot.tag = element_text(color = "black", face = "bold", size = 16))
  
}

#sf1
sf1 <- ((pbmc_clust_figs$cluster_tree + theme(aspect.ratio = NULL)) + wrap_elements(pbmc_clust_figs$hm_grob) + plot_layout(widths = c(7,13))) /
  (pbmc_clust_figs$umap_coarse + pbmc_clust_figs$umap_com) + plot_layout(heights = c(7,3))


ggsave2("figs/sf1.pdf", sf1, width = 16, height = 22)



# main 1
main_clust <- ((ggplot() + theme_void() + labs(tag = "a") + tag_theme()) + (pbmc_clust_figs$umap_ct + labs(tag = "b  ") + tag_theme()) + 
                 pbmc_clust_figs$umap_meld + plot_layout(ncol = 3, nrow = 1, widths = c(3,5,5))) /
  (
    ((plot_spacer() + (pbmc_clust_figs$meld_violins + theme(aspect.ratio = NULL) + facet_wrap(.~ coarse_clusters, scales = "free_x", ncol = 3) + labs(tag = "c") + tag_theme()) + plot_layout(ncol = 1, nrow = 2, heights = c(0,1))) | 
     (plot_spacer() + (pbmc_clust_figs$freq_volcano + labs(tag = "d") + tag_theme()) + (ggplot() + theme_void() + labs(tag = "e") + tag_theme()) + plot_layout(heights = c(0,3,2))))+ plot_layout(widths = c(6,4))) + 
  plot_layout(heights = c(3,6))

ggsave2("figs/fig3.pdf", main_clust, width = 12, height = 12)

# sf2: myeloid characterization

sf2 <- (pbmc_clust_figs$freq_violins + wrap_elements(pbmc_clust_figs$hm_grob_myeloid) + plot_layout(widths = c(7,3))) /
  (pbmc_clust_figs$mono_scores_plot +facet_wrap(. ~ fine_clusters, nrow =1)) / pbmc_clust_figs$myeloid_main_markers +
  plot_layout(heights = c(10,4,6))

ggsave2("figs/sf2.pdf", sf2, width = 15, height = 20)
```

