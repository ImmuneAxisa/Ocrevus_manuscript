---
title: "clustering CSF"
author: "PPA"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    number_sections: yes
    toc: yes
    toc_depth: 4
  html_document:
    df_print: paged
geometry: margin=0.5in
header-includes:
   - \usepackage{subfig}
   - \usepackage{float}
---


```{r setup, include=FALSE}

##########################
## Packages and options ##
##########################

library(gridExtra)
library(knitr)
library(readr)
library(dplyr)
library(tidyr)
library(tibble)
library(stringr)
library(ggplot2)
library(ggExtra)
library(stats)
# library(RColorBrewer)
library(viridis)
library(scales)
library(ggrepel)
library(circlize)
library(RColorBrewer)
library(gplots)
library(cowplot)
library(gtable)
library(data.table)
library(Seurat)
library(hdf5r)
library(ggsci)
library(ggridges)
library(forcats)
library(kableExtra)
library(sp)
# library(FactoMineR)
# library(factoextra)
library(wesanderson)
library(Matrix)
library(DESeq2)
library(edgeR)
library(ashr)
library(vsn)
library(ggsci)
library(ComplexHeatmap)
library(magick)
library(here)
library(readr)
library(pals)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.pos = 'H')
knitr::opts_chunk$set(dev = 'png', dpi = 300, fig.width = 15, fig.asp = 0.8)

#set root directory to be one level up of the current directory
#knitr::opts_knit$set(root.dir = '.')

#Caching option when tweaking the knitting
knitr::opts_chunk$set(cache = T)

WRITE_FILES <- FALSE


##################
## ggplot theme ##
##################

theme_mrl <- function(x = 1, ...) {
  theme_minimal() +
    theme(
      axis.line = element_line(),
      axis.ticks.x = element_line(),
      axis.ticks.y = element_line(),
      axis.text.x = element_text(size = 12*x,face = "bold", angle = 45, vjust = 0.9, hjust=0.9),
      axis.text.y = element_text(size = 12*x,face = "bold"),
      axis.title.x = element_text(size = 12*x,face = "bold"),
      axis.title.y = element_text(size = 12*x,face = "bold"),
      strip.background = element_rect(fill="gray20", colour="gray20", linetype="solid"),
                                      strip.text = element_text(size=12*x, colour="white", face="bold"),
                                      legend.title = element_text(size=14*x, face = "bold"),
                                      legend.text = element_text(size=12*x, color="gray20", face="bold"),
      legend.background = element_rect(fill = "transparent", colour = "transparent"),
      plot.title =  element_text(hjust=0.5, vjust=2, face="bold"),
      plot.subtitle = element_text(hjust=0.5, vjust=3, face="italic"),
      plot.caption = element_text(hjust = 0, face = "italic")
                                      ) +
    theme(...)
}


opts <- options()  # save old options####

options(ggplot2.continuous.colour="viridis")
options(ggplot2.continuous.fill = "viridis")

palette <- c(pal_rickandmorty()(12),pal_jco()(10), pal_futurama()(11), pal_tron()(7), pal_npg()(10), pal_aaas()(10))


options(bitmapType = 'cairo', device = 'png')
```




```{r, fig.width=10}  
theme_umap <- function() {
  theme_void() +
    theme(panel.background = element_rect(fill = "grey90", color = "black", size = 2),
          legend.position = c(1,0),
          legend.justification = c(1.1,0),
          legend.direction = "horizontal",
          legend.text = element_text(angle = 45, hjust = 1, vjust = 1),
          legend.title = element_blank(),
          plot.margin = unit(c(1,1,1,1), "mm"),
          aspect.ratio = 0.7)
  
  
}


# function to overlay values onto the UMAP embeddings
hex_plots <-
  function(data,
           dim1,
           dim2,
           color,
           facets = NULL,
           CI = 0.05,
           fun = "mean",
           bins = 200,
           divergent_scale = F) {
    message("calc CI")
    # calculate the quantilles for CI limits onthe color scale.
    if (CI) {
      lims <- quantile(pull(data, color), probs = c(CI / 2, 1 - CI / 2))
      # if user supplied CI leads to 0 values ef no range, set automatically to 1%
      if (lims[2] == 0) {
        CI <- 0.01
        lims <-
          quantile(pull(data, color), probs = c(CI / 2, 1 - CI / 2))
      }
      # if still 0 values still, do not set any CI
      if (lims[2] == 0) {
        lims <- c(NA, NA)
      }
      
    } else {
      lims <- c(NA, NA)
    }
    
    message("compute plot")
    plot <- ggplot(data, aes_string(dim1, dim2)) +
      stat_summary_hex(
        bins = bins,
        fun = fun,
        aes(z = !!ensym(color), color = ..value..),
        lwd = 0.1
      ) +
      ggtitle(color) +
      theme_mrl() +
      guides(fill = guide_none()) +
      theme_umap()
    
    
    if (divergent_scale) {
      plot <- plot  +
        scale_fill_gradient2(
          midpoint = 0.5,
          low = "royalblue",
          mid = "grey80",
          high = "red4",
          limits = lims,
          oob = squish
        ) +
        scale_color_gradient2(
          midpoint = 0.5,
          low = "royalblue",
          mid = "grey80",
          high = "red4",
          limits = lims,
          oob = squish
        )
    } else {
      plot <- plot +
        scale_fill_viridis(limits = lims, oob = squish) +
        scale_color_viridis(limits = lims, oob = squish)
    }
    
    if (is.null(facets)) {
      return(plot)
    } else {
      return(plot + facet_wrap(as.formula(facets)))
    }
  }


ridges_plots <- function(data,dim1,dim2) {
  
  ggplot(data, 
       aes_string(dim1, 
                  dim2)) +
  stat_density_ridges(aes(fill = factor(stat(quantile))),
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = c(0.01,0.05, 0.1,0.9,0.95,0.99), quantile_lines = TRUE,
    color = NA) +
  facet_grid(curated_types~., scales = "free_y", space = "free_y") +
  scale_fill_manual(labels = c("0.01","0.05", "0.1","0.1-0.9","0.9","0.95","0.99"),
                    values = c("black","grey80","black","grey80","black","grey80","black"))
}



# new 

# function to overlay values onto the UMAP embeddings
hex_plots <-
  function(data,
           dim1,
           dim2,
           color,
           facets = NULL,
           CI = 0.05,
           fun = "mean",
           bins = 200,
           divergent_scale = F) {
    message("calc CI")
    # calculate the quantilles for CI limits onthe color scale.
    if (CI) {
      lims <- quantile(pull(data, color), probs = c(CI / 2, 1 - CI / 2))
      
      # if user supplied CI leads to 0 values ef no range, set automatically to 1%
      if (lims[2] == 0) {
        CI <- 0.01
        lims <-
          quantile(pull(data, color), probs = c(CI / 2, 1 - CI / 2))
      }
      # if still 0 values still, do not set any CI
      if (lims[2] == 0) {
        lims <- c(NA, NA)
      }
      
    } else {
      lims <- c(NA, NA)
    }
    
    message("compute plot")
    plot <- ggplot(data, aes_string(dim1, dim2)) +
      stat_summary_hex(
        bins = bins,
        fun = fun,
        aes(z = !!ensym(color), color = ..value..),
        lwd = 0.1
      ) +
      ggtitle(color) +
      theme_mrl() +
      guides(fill = guide_none()) +
      theme_umap()
    
    
    if (divergent_scale) {
      plot <- plot  +
        scale_fill_gradientn(
          colors = c("purple3","royalblue","grey80","red4","gold"),
          values = rescale(c(lims[1], quantile(pull(data, color), probs = c(0.25,0.5,0.75)), lims[2])),
          limits = lims,
          oob = squish,
          breaks = pretty_breaks(5)
        ) +
        scale_color_gradientn(
          colors = c("purple3","royalblue","grey80","red4","gold"),
          values = rescale(c(lims[1], quantile(pull(data, color), probs = c(0.25,0.5,0.75)), lims[2])),
          limits = lims,
          oob = squish,
          breaks = pretty_breaks(5)
        )
    } else {
      plot <- plot +
        scale_fill_viridis(limits = lims, oob = squish) +
        scale_color_viridis(limits = lims, oob = squish)
    }
    
    if (is.null(facets)) {
      return(plot)
    } else {
      return(plot + facet_wrap(as.formula(facets)))
    }
  }



SingleR_heatmap <- function(singleR_results, meta, k, keepBest = T) {
  
  # Input
  # singleR results: a list with 1/ scores matrix (rows = cluster/cells, col = refs), 2/ calls table on each cells (cells as rows)
  # metadata table with cell barcodes (or cluster calls) as rownames
  # k parameter for cutree, in order to split the dendrogram of cells/clusters
  
  library(ComplexHeatmap)
  
  # add barcodes back to the scores matrix
  rownames(singleR_results[[1]]) <- rownames(singleR_results[[2]])
  
  #print(rownames(singleR_results[[1]]))
  #print(rownames(meta))
  #enforce ordering of cells in the same in scores matrix and metadata
  singleR_results <- singleR_results[[1]][rownames(meta),]
  
  # scale scores per cell to % of max score
  singleR_results <- singleR_results / matrixStats::rowMaxs(singleR_results)
  
  # Only keep refs that have best score for at least one cells
  if(keepBest) {
    singleR_results <- singleR_results[,matrixStats::colMaxs(singleR_results) == 1]
  }
  

  # Print final dim before plotting
  cat("Dimension of matrix to plot after filering",dim(singleR_results))



  # hierrachical clustering
  row_clust <- hclust(dist(t(singleR_results)))

  col_clust <- hclust(dist(singleR_results))

  # cut tree and assign color for heatmap annotation
  cluster_split <- paste0("cluster ", cutree(col_clust, k = k))

  cluster_col <- ggsci::pal_futurama()(k)

  names(cluster_col) <- unique(cluster_split)

  #plot heatmap
  Heatmap(t(singleR_results),
        col = c(viridis(1000),"#ff0000"),
        show_column_names = F,
        bottom_annotation = HeatmapAnnotation(meta),
        top_annotation = HeatmapAnnotation("cluster" = cluster_split, 
                                           col = list("cluster" =cluster_col)),
        cluster_rows = row_clust,
        cluster_columns = col_clust,
        use_raster = T,
        raster_quality = 1)
  
  
  
  
  
  
}


```




```{r}
### plotting function draft for singleR objects
plot_singleR_heatmap <- function(singleR_results, scale = T, kmeans = 10, return_scores = F) {
  
  #### usage options
  # scale: scale cells to max score fraction. Useful to highlight best score and minimize library size effect
  # kmeans: apply kmeans to cluster cells. faster than hierarchical clustering which too slow when dealing with many cells
  # TODO: add option to do hierarchical clustering on the kmeans cluster
  # TODO: add option to print max score in heatmap given matrix size in not too big
  
  if("SummarizedExperiment" %in% class(singleR_results)) {
    # if raw singleR output
    # convert to matrix and metadata
    scores = as.matrix(singleR_results$scores)
    calls = as.data.frame(singleR_results[, colnames(singleR_results) != "scores"])
  } else {
    # if singleR output converted to list of scores and meta, extract each component
    scores = singleR_results$scores
    calls = singleR_results$calls
  }
 
  # add rownames t score matrix
  rownames(scores) <- rownames(calls)
  
  # scale per cell at max value
  scores_scaled <- scores / matrixStats::rowMaxs(scores)
  
  #labels of actual best rho scre if printing score on heatmap. Not used rn
  labels <- (scores_scaled == 1) * scores %>% round(digits = 2)
  
  labels[labels == 0] <- ""
  
  
  if(scale) {
    mat <- scores_scaled
  } else {
    mat <- scores
  }
  
  if(return_scores) {
   return(mat)
 }
  
  
  hm <- ComplexHeatmap::Heatmap(
    mat,
    col = c(viridis(100), "red"),
    km = kmeans,
    cluster_rows = F,
    show_row_names = F,
    use_raster = T
  )
  hm <- draw(hm)
  
 clustering_results <- ComplexHeatmap::row_order(hm) %>%
    enframe("hm_cluster", "id") %>% 
    unnest()
 
 clustering_results <- data.frame(cell.id = rownames(mat)) %>%
   tibble::rownames_to_column("id") %>%
   left_join(clustering_results)
 
 
    
}
```








```{r}

new_names <- tribble(
  ~cluster_label_h, ~cluster_label_new,
  "B cell_1 ", "memory B cells",
  "B cell_2 ", "plasmablasts",
  "CD4_1 ", "memory CD4 1",
  "CD4_2 ", "memory CD4 2",
  "CD4_3 ", "memory CD4 3",
  "CD4_4 ", "memory CD4 4",
  "CD8_1 ", "memory CD8 1",
  "CD8_2 ", "memory CD8 2",
  "DC_1 ", "DC_1",
  "DC_2 ", "DC_2",
  "DC_3 ", "DC_3",
  "gd T ", "gd T",
  "Mø 1", "memory CD4 5",
  "Mø 2", "Mac_1",
  "Monocytes ", "Mac_2",
  "NK ", "NK",
  "pDC ", "pDC",
  "Treg ", "Treg"
)

cluster_colors <- alpha(pals::cols25(), 0.8)[1:nrow(new_names)]

names(cluster_colors) <- gsub("_", " ",pull(new_names, cluster_label_new))

cluster_colors <- cluster_colors[order(names(cluster_colors))]


seurat <- readRDS("results/CSF_analysis/seurat_objects/merged.CSF_integrated_harmony_corrected_cluster_hcluster.rds")

meta <- seurat@meta.data %>% 
  tibble::rownames_to_column("index") %>%
  mutate(hcluster = replace_na(as.character(hcluster), "")) %>%
  mutate(cluster_label_h = paste(cluster_label, hcluster)) %>%
  separate(cluster_label_h, c("main"), sep = "_", extra = "drop", remove = F) %>%
  mutate(curated_clusters = unclass(forcats::fct_infreq(cluster_label_h))) %>%
  left_join(new_names) %>%
  tibble::column_to_rownames("index")

seurat@meta.data <- meta

singleR_res_jess <- readRDS("results/CSF_analysis/reductions/allcells_SingleR_SingleCellScore.rds")




CSF_figs <- list()
```



# cluster calls

```{r}

seurat@meta.data %>% 
  dplyr::select(RNA_snn_res.0.6, cluster_label) %>%
  unique() %>%
  arrange(RNA_snn_res.0.6, cluster_label) %>%
  View()


```




# cluster markers


## global

```{r}
presto_markers <- readRDS("results/CSF_analysis/clustering_typing/presto_paired_markers_curated_clusters_filtered.rds") %>%
  dplyr::filter(!grepl("^RP[LS]", feature)) 

presto_markers <- presto_markers %>%
  group_by(feature, group) %>%
  summarize(count = n(),
            logFC = mean(logFC),
            mlogPadj = mean(-log10(padj + 10^-250))) %>%
  ungroup()

ggplot(presto_markers, aes(count)) +
  geom_histogram()


purrr::map_df(
  1:16,
  ~ presto_markers %>% dplyr::filter(count >= .x) %>% pull(feature) %>% unique() %>% length() %>% data.frame(threshold = .x, n_genes = .)
) %>%
  ggplot(aes(threshold, n_genes)) +
  geom_col()


genes_to_plot <- presto_markers %>%
  dplyr::filter(count > 12) %>%
  pull(feature) %>%
  unique()
```



```{r}
genes_to_plot <- seurat@assays$RNA@data[genes_to_plot,] %>% #marker_genes_to_plot
  as.matrix() %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename_with(~paste0("gene_",.)) %>%
  tibble::rownames_to_column("cell.id")

hm_genes <- meta %>%
  tibble::rownames_to_column("cell.id") %>%
  dplyr::select(cell.id, cluster_label_new) %>%
  left_join(genes_to_plot) %>%
  gather("feat", "val",  -!matches("^gene_")) %>%
  group_by(feat, cluster_label_new) %>%
  summarize(avg = mean(val), sd = sd(val))


hm_genes <- hm_genes %>%
  dplyr::select(-sd) %>%
  mutate(feat = gsub("gene_", "", feat)) %>%
  pivot_wider(names_from = "feat",values_from = "avg") %>%
  tibble::column_to_rownames("cluster_label_new") %>%
  as.matrix() %>%
  scale()


hm <- ComplexHeatmap::Heatmap(t(hm_genes),
                        col = colorRamp2(quantile(hm_genes, c(0.05,0.5,0.95)),
                                         c("royalblue", "grey", "red4")),
                        row_names_gp = gpar(fontsize = 12, fontface = "bold"),
                        column_names_gp = gpar(fontsize = 16, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_centered = T,
                        column_split = NULL) 


hm <- draw(hm)
ori_col_order <- column_order(hm)
ori_row_order <- row_order(hm)

ori_dend <- column_dend(hm)
```

## curated markers


* plasmablast markers (B cell_2): PRDM1, Ig genes (IGHs, IGKs, JCHAIN), KI67, CD38, XBP1, TNFRSF17
* memory B cells (B cell_1): CD79B, CXCR4, CD24, BLK, CD19, MS4A1, BANK1

* macro: APOE, APOC1, TREM2, C1Qs, SCIN, CD9, MSR1
* mono: CCR2, CD36, CD14, CX3CR1, LYZ, ITGAM, CD300E, S100A8, S100A9, S100A12, IL17RA, CD163, TLR2
* DC_1: CD1E, CLEC10A, CLEC4A, CD1C, FCER1A, IL18,
* DC_2: S100B, XCR1, CLEC9A, SLAMF7, SLAMF8
* DC_3: IL15, CD200, CD83, BCL3,
* pDC: IL3RA, IRF7, IRF8, TYROBP, TCF4

* NK: KLRC1, KLRD1, HOPX, KLRC3, NCAM1, NCR1, XCL1, XCL2, IL2RB, CD7, PRF1, NKG7, CTSW
* gd T: KLRG1, TRGV9, TRGV2
* CD8_1: GZMH, CCL4, CCL5, CD8A, CD8B,
* CD8_2: NELL2, TCF7,

* CD4_1: PTGER2, IL7R
* CD4_2: TCF7, LEF1
* CD4_3: CYTOR, CXCR3
* CD4_4 (Th17): RORC, CCR6, 
* Treg: FOXP3, IKZF2, TIGIT


```{r, fig.asp=3, fig.width=8}



presto_markers <- readRDS("results/CSF_analysis/clustering_typing/presto_paired_markers_curated_clusters_filtered.rds") %>%
  dplyr::filter(!grepl("^RP[LS]", feature)) 

presto_markers <- presto_markers %>%
  group_by(feature, group) %>%
  summarize(count = n(),
            logFC = mean(logFC),
            mlogPadj = mean(-log10(padj + 10^-250))) %>%
  ungroup()


genes_to_plot <- c("PRDM1","IGK","JCHAIN","KI67","CD38","XBP1","TNFRSF17","CD79B","CXCR4","CD24$","BLK","CD19","MS4A1","BANK1","APOE","APOC1","TREM2","C1QA", "C1QB","C1QC", "C3","SCIN","CD9","MSR1","CCR2","CD36","CD14","CX3CR1","LYZ","ITGAM","CD300E","S100A8","S100A9","S100A12","IL17RA","CD163","TLR2","CD1E","CLEC10A","CLEC4A","CD1C","FCER1A","IL18","S100B","XCR1","CLEC9A","SLAMF7","SLAMF8","IL15","CD200","CD83","BCL3","IL3RA","IRF7","IRF8","TYROBP","TCF4","KLRC1","KLRD1","HOPX","KLRC3","NCAM1","NCR1","XCL1","XCL2","IL2RB","CD7$","PRF1","NKG7","CTSW","KLRG1","TRGV9","TRGV2","GZMH","CCL4","CCL5","CD8A","CD8B","GZMB","GZMA","NELL2","TCF7","PTGER2","IL7R","TCF7","LEF1","CYTOR","CXCR3","RORC","CCR6","FOXP3","IKZF2","TIGIT")

genes_to_plot <- paste0("^", genes_to_plot) %>% paste(collapse = "|")

genes_to_plot <- grep(genes_to_plot, unique(pull(presto_markers, feature)), value = T) 

genes_to_plot <- seurat@assays$RNA@data[genes_to_plot,] %>% #marker_genes_to_plot
  as.matrix() %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename_with(~paste0("gene_",.)) %>%
  tibble::rownames_to_column("cell.id")

hm_genes <- meta %>%
  tibble::rownames_to_column("cell.id") %>%
  dplyr::select(cell.id, cluster_label_new) %>%
  left_join(genes_to_plot) %>%
  gather("feat", "val",  -!matches("^gene_")) %>%
  group_by(feat, cluster_label_new) %>%
  summarize(avg = mean(val), sd = sd(val))


hm_genes <- hm_genes %>%
  dplyr::select(-sd) %>%
  mutate(feat = gsub("gene_", "", feat)) %>%
  pivot_wider(names_from = "feat",values_from = "avg") %>%
  mutate(cluster_label_new = gsub("_", " ", cluster_label_new)) %>%
  tibble::column_to_rownames("cluster_label_new") %>%
  as.matrix() %>%
  scale()


hm <- ComplexHeatmap::Heatmap(t(hm_genes),
                        col = colorRamp2(quantile(hm_genes, c(0.05,0.5,0.95)),
                                         c("royalblue", "grey", "red4")),
                        row_split = 12,
                        heatmap_legend_param = list(title = "trimmed \nz-score "),
                        #row_km = 6,
                        #row_km_repeats = 100,
                        row_names_gp = gpar(fontsize = 12, fontface = "plain"),
                        cluster_columns = ori_dend,
                        column_dend_height = unit(30, "mm"),
                        column_names_side = "top",
                        column_names_gp = gpar(fontsize = 14, fontface = "plain"),
                        column_names_rot = 90,
                        column_names_centered = F,
                        top_annotation = HeatmapAnnotation(cluster = rownames(hm_genes), col = list(cluster = cluster_colors), show_legend = FALSE),
                        column_split = NULL) 


hm <- draw(hm)
ori_col_order <- column_order(hm)
ori_row_order <- row_order(hm)

CSF_figs[["hm_cluster_main"]] <- grid.grabExpr(draw(hm))
```

## curated markers from Jess



```{r, fig.asp=2, fig.width=8}



presto_markers <- readRDS("results/CSF_analysis/clustering_typing/presto_paired_markers_curated_clusters_filtered.rds") %>%
  dplyr::filter(!grepl("^RP[LS]", feature)) 

presto_markers <- presto_markers %>%
  group_by(feature, group) %>%
  summarize(count = n(),
            logFC = mean(logFC),
            mlogPadj = mean(-log10(padj + 10^-250))) %>%
  ungroup()


genes_to_plot <- c("PRDM1","IGK","JCHAIN","KI67","CD38","XBP1","TNFRSF17","CD79B","CXCR4","CD24$","BLK","CD19","MS4A1","BANK1","APOE","APOC1","TREM2","C1QA", "C1QB","C1QC", "C3","SCIN","CD9","MSR1","CCR2","CD36","CD14","CX3CR1","LYZ","ITGAM","CD300E","S100A8","S100A9","S100A12","IL17RA","CD163","TLR2","CD1E","CLEC10A","CLEC4A","CD1C","FCER1A","IL18","S100B","XCR1","CLEC9A","SLAMF7","SLAMF8","IL15","CD200","CD83","BCL3","IL3RA","IRF7","IRF8","TYROBP","TCF4","KLRC1","KLRD1","HOPX","KLRC3","NCAM1","NCR1","XCL1","XCL2","IL2RB","CD7$","PRF1","NKG7","CTSW","KLRG1","TRGV9","TRGV2","GZMH","CCL4","CCL5","CD8A","CD8B","GZMB","GZMA","NELL2","TCF7","PTGER2","IL7R","TCF7","LEF1","CYTOR","CXCR3","RORC","CCR6","FOXP3","IKZF2","TIGIT")



genes_to_plot <- c("C1QC","C1QB","CST3","C1QA","RHOB","APOE","CD14","TYROBP","HLA-DRA","CD74","FOS","HLA-DRB5","AIF1","HLA-DPA1","FTH1","HLA-DRB1","SAT1","FCER1G","CXCL16","PSAP","HLA-DPB1","CEBPD","CD68","TREM2","FTL","DUSP1","LYZ","CTSB","C5AR1","SPI1","HLA-DMA","APOC1","HLA-DQB1","HLA-DQA1","MS4A6A","CSF1R","NPC2","FCGBP","SERPINA1","A2M","TUBA1B","VMO1","SELENOP","CYBB","CFD","IFI30","FCGR2A","IFITM3","HLA-DQA2","PILRA","RNF130","CD83","SRGN","CD9","PLAUR","GRN","CH25H","MS4A7","YWHAH","FCGR3A","MS4A7","MEF2C","CLEC7A")





genes_to_plot <- paste0("^", genes_to_plot) %>% paste(collapse = "|")

genes_to_plot <- grep(genes_to_plot, unique(pull(presto_markers, feature)), value = T) 

genes_to_plot <- seurat@assays$RNA@data[genes_to_plot,] %>% #marker_genes_to_plot
  as.matrix() %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename_with(~paste0("gene_",.)) %>%
  tibble::rownames_to_column("cell.id")

hm_genes <- meta %>%
  tibble::rownames_to_column("cell.id") %>%
  dplyr::select(cell.id, cluster_label_new) %>%
  left_join(genes_to_plot) %>%
  gather("feat", "val",  -!matches("^gene_")) %>%
  group_by(feat, cluster_label_new) %>%
  summarize(avg = mean(val), sd = sd(val))


hm_genes <- hm_genes %>%
  dplyr::select(-sd) %>%
  mutate(feat = gsub("gene_", "", feat)) %>%
  pivot_wider(names_from = "feat",values_from = "avg") %>%
  mutate(cluster_label_new = gsub("_", " ", cluster_label_new)) %>%
  tibble::column_to_rownames("cluster_label_new") %>%
  as.matrix() %>%
  scale()


hm <- ComplexHeatmap::Heatmap(t(hm_genes),
                        col = colorRamp2(quantile(hm_genes, c(0.05,0.5,0.95)),
                                         c("royalblue", "grey", "red4")),
                        row_split = 8,
                        heatmap_legend_param = list(title = "z-score", 
                                                    title_gp = gpar(fontsize = 10, fontface = "plain"),
                                                    title_position = "leftcenter",
                                                    legend_direction = "horizontal"),
                        #row_km = 6,
                        #row_km_repeats = 100,
                        row_names_gp = gpar(fontsize = 12, fontface = "plain"),
                        cluster_columns = ori_dend,
                        column_dend_height = unit(30, "mm"),
                        column_names_side = "top",
                        column_names_gp = gpar(fontsize = 14, fontface = "plain"),
                        column_names_rot = 90,
                        column_names_centered = F,
                        top_annotation = HeatmapAnnotation(cluster = rownames(hm_genes), col = list(cluster = cluster_colors), show_legend = FALSE),
                        column_split = NULL) 


hm <- draw(hm, heatmap_legend_side = "bottom")
ori_col_order <- column_order(hm)
ori_row_order <- row_order(hm)

CSF_figs[["hm_cluster_myelo"]] <- grid.grabExpr(draw(hm))
```





```{r}


results <- apply(singleR_res_jess, MARGIN = 2, function(score, lib_size){
  
  model <- lm(score ~ log(lib_size))
  
  model_residuals <- residuals(model)
  
  #print(plot(lib_size, score))
  
  #print(plot(lib_size, model_residuals))
  
  return(model_residuals)
  
}, lib_size = seurat@meta.data$nCount_RNA)


colnames(results) <- colnames(singleR_res_jess)

CSF_genes_plots <- seurat@assays$RNA@data[c("APOE", "APOC1", "TREM2"),]  %>% #marker_genes_to_plot
  as.matrix() %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename_with(~paste0("gene_",.)) %>%
  tibble::rownames_to_column("cell.id") %>% 
  gather("feat", "value", -cell.id) %>%
  left_join(meta %>% tibble::rownames_to_column("cell.id") %>% dplyr::select(cell.id, cluster_label_new, hcluster)) %>%
  dplyr::filter(hcluster != "") %>%
  left_join(results %>% as.data.frame() %>% tibble::rownames_to_column("cell.id") %>% dplyr::select(matches("cell\\.id|mono"))) %>%
  ggplot(aes(`Intermediate monocytes`, value)) +
  geom_smooth(color = "red") +
  geom_hex(aes(color = after_scale(fill)), bins = 100) +
  #geom_density_2d(aes(color = hcluster), contour_var = "ndensity", bins = 50) +
  facet_grid(feat~reorder(cluster_label_new, as.numeric(hcluster)), scales = "free_y", switch = "y") +
  scale_fill_viridis(trans = "log10") +
  theme_mrl() +
  theme(strip.placement = "outside",
        panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
        panel.grid.minor.x = element_blank(),
        strip.background = element_rect(fill = "black", color = "white", linetype = "solid"),
        panel.spacing = unit(0, "npc"),
        axis.title.y = element_blank(),
        panel.border = element_rect(fill = NA, color = "black", linetype = "solid"))

CSF_genes_plots

CSF_figs[["CSF_genes"]] <- CSF_genes_plots

```






# UMAP iterations


```{r, fig.width=10, fig.asp=1.2}
umaps_cleaned <- readRDS("results/CSF_analysis/clustering_typing/UMAP_harmony_CSF_extra.rds") %>%
  dplyr::select(matches("cell\\.id|^UMAPn30")) %>%
  pivot_longer(-cell.id, names_to = "it", values_to = "value") %>%
  separate(it, c("it", "dim"), sep = "_") %>%
  mutate(dim = paste0("dim",dim)) %>%
  pivot_wider(names_from = dim, values_from = value) %>%
  left_join(meta %>% tibble::rownames_to_column("cell.id") %>% dplyr::select(cell.id, hcluster)) %>%
  dplyr::filter(!grepl("tSNE", it)) %>%
  group_by(it) %>%
  mutate(dim1 = rescale(dim1), dim2 = rescale(dim2)) %>%
  separate(it, c("it", "md", "s"), sep = "x") %>%
  mutate(md = parse_number(gsub("Md([0-9])", "\\1\\.", md)),
         s = parse_number(s))

 
  
plots <- umaps_cleaned %>%
  #left_join(meta %>% tibble::rownames_to_column("cell.id") %>% dplyr::select(cell.id, cluster_label_new)) %>%
  #dplyr::filter(md > 0.7) %>%
  group_by(it) %>%
  nest() %>%
  mutate(plot = purrr::map2(it, data, ~ .y %>%
  ggplot(aes(dim1,dim2)) +
  geom_hex(bins = 100) +
  geom_density2d(aes(color = hcluster), bins = 3, contour_var = "ndensity") +
  facet_grid(md~s) +
  theme_mrl() +
  theme_umap() +
  theme(legend.position = "none") +
  ggtitle(.x)
  )) %>%
  pull(plot)
```





```{r, fig.width=10}

umap_plot_data<- umaps_cleaned %>%
  dplyr::filter(it == "UMAPn30" & md == 2 & s == 1) %>%
  left_join(meta %>% tibble::rownames_to_column("cell.id") %>% dplyr::select(cell.id, cluster_label_new, curated_clusters)) %>%
  mutate(cluster_label_new = gsub("_", " ", cluster_label_new)) %>%
  mutate(dim1 =rescale(dim1) - 0.5, dim2 = rescale(dim2) - 0.5)

cluster_labels <- umap_plot_data %>%
  group_by(cluster_label_new) %>%
  summarize(dim1 = median(dim1), dim2 = median(dim2))

plot <- umap_plot_data %>%
  slice_sample(prop =1) %>% #shuffle rows
  ggplot(aes(dim1,dim2)) +
  ggrastr::geom_point_rast(aes(color = reorder(cluster_label_new, curated_clusters))) +
  #geom_density_2d_filled(aes(fill = cluster_label_new, alpha = ..level..), contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) +
  scale_color_manual(values = cluster_colors) +
  scale_fill_manual(values = cluster_colors) +
  geom_text_repel(
    data = cluster_labels,
    aes(label = cluster_label_new, fill = cluster_label_new),
    color = "black",
    size = 5,
    alpha = 0.7,
    min.segment.length = unit(0, "cm"),
    force = 50,
    max.iter = 10000,
    #nudge_x = (cluster_labels$dim1)*2*(cluster_labels$dim2 < -0.2),
    #nudge_y = ,
    show.legend = FALSE
  )

p1 <- plot +
  theme_mrl() +
  theme_umap() +
  theme(legend.position = "none") +
  annotate("text", label = "UMAP", x = -Inf, y = -Inf, hjust = -0.5, vjust = -0.5)


p2 <- plot_grid(get_legend(plot + theme(legend.title = element_blank(),
                                        legend.key = element_rect(fill= "grey90")) +
                             guides(color = guide_legend(label.position = "left",
                             label.hjust = 1, override.aes = list(size = 3)))))


plot_grid(p1,p2, rel_widths = c(8,2))


CSF_figs[["UMAP"]] <- p1
CSF_figs[["UMAP_legend"]] <- p2
```


# MELD 

## scores for baseline vs Followup

```{r, fig.width=15}
BvF <- read_csv("./results/CSF_analysis/phate_meld_output/BaselinevsFollow_up_BaselinevsFollow_up_all_CSF_MELD_LLH.csv")

BvF <- umaps_cleaned %>%
  dplyr::filter(it == "UMAPn30" & md == 2 & s == 1) %>%
  left_join(meta %>% tibble::rownames_to_column("cell.id") %>% dplyr::select(cell.id, cluster_label_new, patient, LP)) %>%
  left_join(BvF, by = c("cell.id" = "index")) %>%
  mutate(cluster_label_new = gsub("_", " ", cluster_label_new))


meld_plot <- ggplot(BvF) +
  geom_rect(xmin = -Inf, xmax = Inf, ymin = 0.4, ymax = 0.6, fill = "grey") +
  geom_hline(yintercept = c(0.5,1)) +
  geom_violin(aes(".global", Follow_up)) +
  #annotate("text", x = " ", y = 0.5, label = "global", angle = 90) +
  stat_summary(aes(cluster_label_new, 
                 Follow_up, 
                 group = patient,
                 fill = cluster_label_new),
               position = position_dodge(width = 0.8),
               shape = 21,
               size = 0.5,
               alpha = 1,
               fun.data = function(x){
                 mu = mean(x)
                 se = sd(x)
                 return(c(ymin = mu -se, y = mu, ymax = mu + se))
               }) +
  scale_fill_manual(values = cluster_colors) +
  theme_mrl(2) +
  labs(x = NULL, y = "pre vs post-treatment MELD likelihood") +
  scale_y_continuous(breaks = 0:10/10,
                     limits = c(0,1),
                     expand = expand_scale(mult = 0)) +
  theme(
    panel.border = element_rect(
      colour = "black",
      fill = NA,
      size = 1
    ),
    axis.line = element_blank(),
    legend.position = "none",
    strip.text = element_blank(),
    #axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.x = element_text(color = "black", face = "plain"),
    axis.text.y = element_text(color = "black", face = "plain"),
    axis.title.y = element_text(color = "black", face = "plain"),
    strip.background = element_blank(),
    plot.title = element_text(color = "black", face = "plain"),
    aspect.ratio = 0.5
  ) +
  guides(fill = guide_legend(ncol = 1))

CSF_figs[["meld_plot"]] <- meld_plot
```


```{r, fig.width=5}
umap_meld <- BvF %>%
  dplyr::filter(!is.na(Follow_up)) %>%
  hex_plots("dim1",
            "dim2",
            "Follow_up",
            CI = 0.01,
            divergent_scale = T) +
  ggtitle("Follow up vs Baseline MELD likelihood") + 
  theme(plot.title = element_text(face = "plain"))


CSF_figs[["umap_meld"]] <- umap_meld
```


## Initial scores

```{r, fig.width=15}

BvHC <- read_csv("results/CSF_analysis/phate_meld_output/BaselinevsHealthy_BaselinevsHealthy_all_CSF_MELD_LLH.csv")

BvHC <- umaps %>%
  dplyr::filter(it == "UMAPn30" & md == 2 & s == 1) %>%
  left_join(meta %>% tibble::rownames_to_column("cell.id") %>% dplyr::select(cell.id, cluster_label_new, patient, LP)) %>%
  left_join(BvHC, by = c("cell.id" = "index"))
```



# cell type freq

## observed


```{r, fig.width=17, fig.asp=0.8}
freq <- meta %>%
  mutate(cluster_label_new = gsub("_", " ", cluster_label_new)) %>%
  mutate(LP = gsub("_", " ", LP)) %>%
  unite("ID", patient, LP, sep = "___") %>%
  mutate(ID = as.factor(ID), cluster_label_new = as.factor(cluster_label_new)) %>%
  group_by(ID, cluster_label_new, .drop = F) %>%
  summarize(count = n()) %>%
  separate(ID, c("patient", "LP"), sep = "___") %>%
  ungroup() %>%
  group_by(patient, LP) %>%
  mutate(freq = count / sum(count))


betareg_model_treatment <- freq %>%
  group_by(cluster_label_new) %>%
  mutate(y_max = max(freq)) %>%
  dplyr::filter(LP != "Healthy") %>%
  mutate(freq = freq + 0.001) %>%
  nest() %>%
  mutate(lm_result = purrr::map(data, ~betareg::betareg(freq ~ LP + patient, .x))) %>%
  mutate(y_max = purrr::map(data, ~max(pull(.x,y_max)))) %>%
  dplyr::select(-data) %>%
  mutate(conv = purrr::map(lm_result, ~.x[["converged"]])) %>%
  mutate(lm_result = purrr::map(lm_result, broom::tidy)) %>%
  unnest() %>%
  dplyr::filter(grepl("LP", term)) %>%
  ungroup() %>%
  mutate(p.value = ifelse(conv, p.value, NA)) %>%
  mutate(fdr = p.adjust(p.value, method = "fdr")) %>%
  mutate(x_min = "Baseline", x_max = "Follow up")
  

betareg_model_disease <- freq %>%
  group_by(cluster_label_new) %>%
  mutate(y_max = max(freq)) %>%
  dplyr::filter(LP != "Follow_up") %>%
  mutate(freq = freq + 0.001) %>%
  nest() %>%
  mutate(lm_result = purrr::map(data, ~ betareg::betareg(freq ~ LP, .x))) %>%
  mutate(y_max = purrr::map(data, ~max(pull(.x,y_max)))) %>%
  dplyr::select(-data) %>%
  mutate(conv = purrr::map(lm_result, ~.x[["converged"]])) %>%
  mutate(lm_result = purrr::map(lm_result, broom::tidy)) %>%
  unnest() %>%
  dplyr::filter(grepl("LP", term)) %>%
  ungroup() %>%
  mutate(p.value = ifelse(conv, p.value, NA)) %>%
  mutate(fdr = p.adjust(p.value, method = "fdr")) %>%
  mutate(x_min = "Baseline", x_max = "Healthy")


ggplot(freq, aes(paste(patient,LP), freq, fill = cluster_label_new)) +
  geom_bar(stat = "identity")

freq_mac <- freq %>%
  dplyr::filter(str_detect(cluster_label_new, "Mac")) %>%
  ggplot(aes(LP, freq*100)) +
  geom_line(aes(group = patient)) +
  geom_point(size = 5) +
  facet_wrap(.~cluster_label_new, scales = "free_y", nrow = 1) +
  scale_y_log10(oob = squish_infinite) +
  annotation_logticks(sides = "l") +
  theme_mrl() +
  theme(legend.position = "left") +
  scale_size(range = c(2,12), breaks = 10^c(1,2,3,4)) +
  ggsignif::geom_signif(data = betareg_model_treatment %>% 
                          dplyr::filter(str_detect(cluster_label_new, "Mac")) %>%
                          dplyr::filter(fdr < 0.1) %>%
                          mutate(y_max = log10(y_max*100 + 10), p.value = round(p.value, 3)) %>%
                          mutate(p.value = ifelse(p.value == 0, as.character(expression(""<10^-3)), p.value)), 
                        aes(xmin = x_min, xmax = x_max, annotations = p.value, y_position = y_max),
                        textsize = 3, vjust = -0.2,
                        manual = T,
                        tip_length = 0,
                        parse = T) +
  ggsignif::geom_signif(data = betareg_model_disease %>% 
                          dplyr::filter(fdr < 0.1) %>%
                          dplyr::filter(str_detect(cluster_label_new, "Mac")) %>%
                          mutate(y_max = log10(y_max*100 + 20), p.value = round(p.value, 3)) %>%
                          mutate(p.value = ifelse(p.value == 0, as.character(expression(""<10^-3)), p.value)), 
                        aes(xmin = x_min, xmax = x_max, annotations = p.value, y_position = y_max),
                        textsize = 3, vjust = -0.2,
                        manual = T,
                        tip_length = 0,
                        parse = T) +
  labs(y = "%") +
  guides(size = guide_legend(title = "# cells")) +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "plain", color = "black", size = 14),
    axis.text.x = element_text(color = "black", face = "plain", size = 14),
    axis.text.y = element_text(color = "black", face = "plain", size = 14),
    axis.title.y = element_text(color = "black", face = "plain", size = 14)
  )




freq_other <- freq %>%
  dplyr::filter(!str_detect(cluster_label_new, "Mac")) %>%
  ggplot(aes(LP, freq*100)) +
  geom_line(aes(group = patient)) +
  geom_point(size = 5) +
  facet_wrap(.~cluster_label_new, scales = "free_y", nrow = 3) +
  scale_y_log10(oob = squish_infinite) +
  annotation_logticks(sides = "l") +
  theme_mrl() +
  theme(legend.position = "left") +
  scale_size(range = c(2,12), breaks = 10^c(1,2,3,4)) +
  ggsignif::geom_signif(data = betareg_model_treatment %>% 
                          dplyr::filter(!str_detect(cluster_label_new, "Mac")) %>%
                          dplyr::filter(fdr < 0.1) %>%
                          mutate(y_max = log10(y_max*100 + 10), p.value = round(p.value, 3)) %>%
                          mutate(p.value = ifelse(p.value == 0, as.character(expression(""<10^-3)), p.value)), 
                        aes(xmin = x_min, xmax = x_max, annotations = p.value, y_position = y_max),
                        textsize = 3, vjust = -0.2,
                        manual = T,
                        tip_length = 0,
                        parse = T) +
  ggsignif::geom_signif(data = betareg_model_disease %>% 
                          dplyr::filter(fdr < 0.1) %>%
                          dplyr::filter(!str_detect(cluster_label_new, "Mac")) %>%
                          mutate(y_max = log10(y_max*100 + 20), p.value = round(p.value, 3)) %>%
                          mutate(p.value = ifelse(p.value == 0, as.character(expression(""<10^-3)), p.value)), 
                        aes(xmin = x_min, xmax = x_max, annotations = p.value, y_position = y_max),
                        textsize = 3, vjust = -0.2,
                        manual = T,
                        tip_length = 0,
                        parse = T) +
  labs(y = "%") +
  guides(size = guide_legend(title = "# cells")) +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "plain", color = "black", size = 14),
    axis.text.x = element_text(color = "black", face = "plain", size = 14),
    axis.text.y = element_text(color = "black", face = "plain", size = 14),
    axis.title.y = element_text(color = "black", face = "plain", size = 14)
  )




CSF_figs[["freq_mac"]] <- freq_mac
CSF_figs[["freq_other"]] <- freq_other
```


# Jess figures


```{r}
saveRDS(CSF_figs, "figs/CSF_figures.rds")


jess_figs <- readRDS("figs/CSF_figures_plots_Jess.rds")
```


```{r}



jess_figs$fig_2a <- NULL

jess_figs[["fig_1f_CNSmac"]][[1]][["data"]][["ident"]] <- gsub("CD14.*_", 
                                                               "Mac_", 
                                                               jess_figs[["fig_1f_CNSmac"]][[1]][["data"]][["ident"]])
jess_figs[["fig_1f_microglia"]][[1]][["data"]][["ident"]] <- gsub("CD14.*_", 
                                                                  "Mac_", 
                                                                  jess_figs[["fig_1f_microglia"]][[1]][["data"]][["ident"]])
jess_figs[["fig_1f_Panmac"]][[1]][["data"]][["ident"]] <- gsub("CD14.*_", 
                                                               "Mac_", 
                                                               jess_figs[["fig_1f_Panmac"]][[1]][["data"]][["ident"]])
jess_figs[["fig_2e_classical"]][[1]][["data"]][["ident"]] <- gsub("CD14.*_", 
                                                                  "Mac_", 
                                                                  jess_figs[["fig_2e_classical"]][[1]][["data"]][["ident"]])
jess_figs[["fig_2e_int"]][[1]][["data"]][["ident"]] <- gsub("CD14.*_", 
                                                            "Mac_", 
                                                            jess_figs[["fig_2e_int"]][[1]][["data"]][["ident"]])
jess_figs[["fig_2e_nonclassical"]][[1]][["data"]][["ident"]] <- gsub("CD14.*_", 
                                                                     "Mac_", 
                                                                     jess_figs[["fig_2e_nonclassical"]][[1]][["data"]][["ident"]])




jess_figs$fig_2c[[1]]$layers <- NULL
jess_figs$fig_2c[[1]] <- jess_figs$fig_2c[[1]] + geom_density_ridges()


jess_figs[["fig_1f_CNSmac"]][[1]][["data"]][["ident"]] <- gsub("_", " ", jess_figs[["fig_1f_CNSmac"]][[1]][["data"]][["ident"]])
jess_figs[["fig_1f_microglia"]][[1]][["data"]][["ident"]] <- gsub("_", " ", jess_figs[["fig_1f_microglia"]][[1]][["data"]][["ident"]])
jess_figs[["fig_1f_Panmac"]][[1]][["data"]][["ident"]] <- gsub("_", " ", jess_figs[["fig_1f_Panmac"]][[1]][["data"]][["ident"]])

jess_figs[["fig_2b_class1"]][[1]][["data"]][["ident"]] <- gsub("_", " ", jess_figs[["fig_2b_class1"]][[1]][["data"]][["ident"]])
jess_figs[["fig_2b_class2"]][[1]][["data"]][["ident"]] <- gsub("_", " ", jess_figs[["fig_2b_class2"]][[1]][["data"]][["ident"]])
jess_figs[["fig_2c"]][[1]][["data"]][["ident"]] <- gsub("_", " ", jess_figs[["fig_2c"]][[1]][["data"]][["ident"]])
levels(jess_figs[["fig_2d"]][["data"]][["id"]]) <- gsub("_", " ", levels(jess_figs[["fig_2d"]][["data"]][["id"]]))

jess_figs[["fig_2e_classical"]][[1]][["data"]][["ident"]] <- gsub("_", " ", jess_figs[["fig_2e_classical"]][[1]][["data"]][["ident"]])
jess_figs[["fig_2e_int"]][[1]][["data"]][["ident"]] <- gsub("_", " ", jess_figs[["fig_2e_int"]][[1]][["data"]][["ident"]])
jess_figs[["fig_2e_nonclassical"]][[1]][["data"]][["ident"]] <- gsub("_", " ", jess_figs[["fig_2e_nonclassical"]][[1]][["data"]][["ident"]])




saveRDS(jess_figs, "figs/CSF_figures_plots_Jess_corrected.rds")

```



# build 1st pass figures


```{r}


jess_figs <- readRDS("figs/CSF_figures_plots_Jess_corrected.rds") %>%
  lapply(function(x) {
    x <-
      x &
      theme(
        axis.text.x = element_text(color = "black", face = "plain"),
        axis.text.y = element_text(color = "black", face = "plain"),
        axis.title.x = element_text(color = "black", face = "plain"),
        axis.title.y = element_text(color = "black", face = "plain"),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", face = "plain"),
        plot.title = element_text(color = "black", face = "plain")
      )
    if(!is.null(x[[1]]$labels$title)) {
      x[[1]]$labels$title <- gsub("CSF Myeloid Clusters ", "", x[[1]]$labels$title)
    }
    return(x)

  })


CSF_figs <- readRDS("figs/CSF_figures.rds") 

```




```{r, fig.width= 20, fig.asp=2}
library(patchwork)

patchwork_panel <- function(x) {
  
  plot_annotation(x, theme = theme(plot.title = element_text(color = "black", face = "bold", size = 16)))
  
}

tag_theme <- function(x) {
  
    theme(plot.tag = element_text(color = "black", face = "bold", size = 16))
  
}


cartoon <- ggplot() + annotate("text", 0,0, label = "xp design cartoon") + theme_void() + theme(panel.background = element_rect(fill = "grey")) + labs(tag = "a") + tag_theme()


fig1 <-
  (cartoon + 
     (CSF_figs$UMAP + labs(tag = "b") + tag_theme()) + 
     (CSF_figs$freq_mac + labs(tag = "c") + tag_theme()) + 
     plot_layout(widths = c(1, 2, 1))) / # first row
  # second row first column
  (
    wrap_elements(
      wrap_elements(CSF_figs$umap_meld) / (
        plot_spacer() + (CSF_figs$meld_plot + coord_flip() + theme(aspect.ratio = NULL)) + plot_layout(widths = c(0, 1))
      ) + patchwork_panel("d") + plot_layout(heights = c(1, 3)) & theme(plot.margin = unit(c(0,1,0,1),"mm"))
    ) +
      # second row 2nd column
      (wrap_elements(plot_spacer() + wrap_elements(CSF_figs$hm_cluster_myelo) + patchwork_panel("e") + plot_layout(heights = c(0, 1)))) +
      # second row third column
      (
        (jess_figs$fig_1f_microglia[[1]] + labs(tag = "f") + tag_theme()) / 
          jess_figs$fig_1f_CNSmac[[1]]  / 
          jess_figs$fig_1f_Panmac[[1]] *
          scale_fill_manual(values = cluster_colors) * 
          theme(axis.title.x = element_blank())
      ) +
      plot_layout(
        ncol = 3,
        nrow = 1,
        widths = c(6.5, 5.5, 2)
      )
  ) +
  # row relative areas
  plot_layout(heights = c(1, 3))


ggsave2("figs/fig1.pdf", fig1, width = 16, height = 22)



fig2 <- (((jess_figs$fig_2a + theme(legend.position = "none")) + labs(tag = "a") + tag_theme()) /
           (((jess_figs$fig_2b_class1[[1]] + coord_flip() + labs(tag = "b") + tag_theme()) /
               (jess_figs$fig_2b_class2[[1]] + coord_flip()) /
               (jess_figs$fig_2c[[1]] + labs(tag = "c") + tag_theme())
           ) * theme(axis.title.y = element_blank(),
                     plot.title = element_text(size = 14)) |
             wrap_elements(
               jess_figs$fig_2d + theme(
                 legend.position = "bottom",
                 legend.direction = "vertical",
                 axis.title.x = element_blank(),
                 axis.title.y = element_blank(),
                 axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1)
               ) +
                 guides(size = guide_legend(title = "%\nexpression"),
                        color = guide_colorbar(title = "Average\nexpression")) +
                 labs(tag = "d\n") + tag_theme()
             )
           )) |
  (
    wrap_elements(
      (jess_figs$fig_2e_classical[[1]] + labs(tag = "e") + tag_theme()) /
        jess_figs$fig_2e_int[[1]] /
        jess_figs$fig_2e_nonclassical[[1]] *
        scale_fill_manual(values = cluster_colors) *
        theme(plot.title = element_text(size = 14),
              axis.title.x = element_blank())
    )
  ) +
  plot_layout(widths = c(2, 1))

ggsave2("figs/fig2.pdf", fig2, width = 14, height = 14)


```




```{r}

```



